name: CI

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop

env:
  GO_VERSION: "1.25"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
            goos: linux
            goarch: amd64

          - os: linux
            arch: arm64
            goos: linux
            goarch: arm64

          - os: darwin
            arch: amd64
            goos: darwin
            goarch: amd64

          - os: darwin
            arch: arm64
            goos: darwin
            goarch: arm64

          - os: windows
            arch: amd64
            goos: windows
            goarch: amd64
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: |
            **/go.mod
            **/go.sum

      - name: Cache Go modules
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ env.GO_VERSION }}-

      - name: Cache tools
        uses: actions/cache@v5
        id: cache-tools
        with:
          path: bin
          key: ${{ runner.os }}-tools-${{ hashFiles('Makefile', 'tools/mockgen/**', 'tools/golangci-lint/**') }}
          restore-keys: |
            ${{ runner.os }}-tools-

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Build tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: make tools-install

      - name: Cache contracts dependencies
        uses: actions/cache@v5
        id: cache-contracts-deps
        with:
          path: |
            contracts/protobuf/deps/googleapis
            contracts/protobuf/deps/protobuf
            contracts/protobuf/deps/protoc-gen-validate
            contracts/protobuf/deps/grpc-gateway
          key: ${{ runner.os }}-contracts-deps-${{ hashFiles('.gitmodules', 'contracts/protobuf/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-contracts-deps-

      - name: Initialize contracts dependencies
        if: steps.cache-contracts-deps.outputs.cache-hit != 'true'
        run: make contracts-deps

      - name: Generate contracts
        run: |
          export PATH="$PWD/bin:$PATH"
          make contracts-protobuf-gen-go

      - name: Build all services
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: make build-all

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        continue-on-error: true
        with:
          name: build-artifacts-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            internal/apps/user/kgym-user-service-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}
            internal/apps/file/kgym-file-service-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}
            internal/apps/sso/kgym-sso-service-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}
            internal/gateway/kgym-gateway-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.os == 'windows' && '.exe' || '' }}
          retention-days: 7
        if: always()

  lint:
    name: Lint
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: |
            **/go.mod
            **/go.sum

      - name: Cache Go modules
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ env.GO_VERSION }}-

      - name: Cache tools
        uses: actions/cache@v5
        id: cache-tools
        with:
          path: bin
          key: ${{ runner.os }}-tools-${{ hashFiles('Makefile', 'tools/mockgen/**', 'tools/golangci-lint/**') }}
          restore-keys: |
            ${{ runner.os }}-tools-

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Build tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: make tools-install

      - name: Cache contracts dependencies
        uses: actions/cache@v5
        id: cache-contracts-deps
        with:
          path: |
            contracts/protobuf/deps/googleapis
            contracts/protobuf/deps/protobuf
            contracts/protobuf/deps/protoc-gen-validate
            contracts/protobuf/deps/grpc-gateway
          key: ${{ runner.os }}-contracts-deps-${{ hashFiles('.gitmodules', 'contracts/protobuf/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-contracts-deps-

      - name: Initialize contracts dependencies
        if: steps.cache-contracts-deps.outputs.cache-hit != 'true'
        run: make contracts-deps

      - name: Generate contracts
        run: |
          export PATH="$PWD/bin:$PATH"
          make contracts-protobuf-gen-go

      - name: Run golangci-lint on all services
        run: |
          export PATH="$PWD/bin:$PATH"
          make lint-all

  test:
    name: Test
    needs: [build]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: |
            **/go.mod
            **/go.sum

      - name: Cache Go modules
        uses: actions/cache@v5
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ env.GO_VERSION }}-

      - name: Cache tools
        uses: actions/cache@v5
        id: cache-tools
        with:
          path: bin
          key: ${{ runner.os }}-tools-${{ hashFiles('Makefile', 'tools/mockgen/**', 'tools/golangci-lint/**') }}
          restore-keys: |
            ${{ runner.os }}-tools-

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Build tools
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: make tools-install

      - name: Cache contracts dependencies
        uses: actions/cache@v5
        id: cache-contracts-deps
        with:
          path: |
            contracts/protobuf/deps/googleapis
            contracts/protobuf/deps/protobuf
            contracts/protobuf/deps/protoc-gen-validate
            contracts/protobuf/deps/grpc-gateway
          key: ${{ runner.os }}-contracts-deps-${{ hashFiles('.gitmodules', 'contracts/protobuf/Makefile') }}
          restore-keys: |
            ${{ runner.os }}-contracts-deps-

      - name: Initialize contracts dependencies
        if: steps.cache-contracts-deps.outputs.cache-hit != 'true'
        run: make contracts-deps

      - name: Generate contracts
        run: |
          export PATH="$PWD/bin:$PATH"
          make contracts-protobuf-gen-go

      - name: Run tests with coverage for all services
        run: |
          export PATH="$PWD/bin:$PATH"
          ROOT_DIR="$PWD"
          mkdir -p "$ROOT_DIR/coverage"
          for service in gateway sso user file; do
            if [ "$service" = "gateway" ]; then
              if [ -f internal/gateway/Makefile ]; then
                cd internal/gateway
                gotestsum --format short-verbose -- -coverprofile="$ROOT_DIR/coverage/${service}.out" -covermode=atomic ./internal/...
                cd "$ROOT_DIR"
              fi
            elif [ -f internal/apps/${service}/Makefile ]; then
              cd internal/apps/${service}
              gotestsum --format short-verbose -- -coverprofile="$ROOT_DIR/coverage/${service}.out" -covermode=atomic ./internal/... ./migrations/...
              cd "$ROOT_DIR"
            fi
          done

      - name: Generate coverage reports and badges
        run: |
          ROOT_DIR="$PWD"
          mkdir -p coverage/badges
          for service in gateway sso user file; do
            if [ -f "coverage/${service}.out" ]; then
              if [ "$service" = "gateway" ] && [ -f internal/gateway/Makefile ]; then
                cd internal/gateway
                go tool cover -func="$ROOT_DIR/coverage/${service}.out" > "$ROOT_DIR/coverage/${service}.txt" 2>/dev/null || true
                go tool cover -html="$ROOT_DIR/coverage/${service}.out" -o "$ROOT_DIR/coverage/${service}.html" 2>/dev/null || true
                COVERAGE_OUTPUT=$(go tool cover -func="$ROOT_DIR/coverage/${service}.out" 2>/dev/null | grep total || echo "")
                cd "$ROOT_DIR"
              elif [ -f "internal/apps/${service}/Makefile" ]; then
                cd "internal/apps/${service}"
                go tool cover -func="$ROOT_DIR/coverage/${service}.out" > "$ROOT_DIR/coverage/${service}.txt" 2>/dev/null || true
                go tool cover -html="$ROOT_DIR/coverage/${service}.out" -o "$ROOT_DIR/coverage/${service}.html" 2>/dev/null || true
                COVERAGE_OUTPUT=$(go tool cover -func="$ROOT_DIR/coverage/${service}.out" 2>/dev/null | grep total || echo "")
                cd "$ROOT_DIR"
              else
                COVERAGE_OUTPUT=""
              fi
              if [ -n "$COVERAGE_OUTPUT" ]; then
                COVERAGE=$(echo "$COVERAGE_OUTPUT" | awk '{print $3}' | sed 's/%//')
                COVERAGE_INT=$(echo "$COVERAGE" | cut -d. -f1)
                if [ -z "$COVERAGE_INT" ]; then
                  COVERAGE_INT=0
                fi
                if [ "$COVERAGE_INT" -ge 80 ]; then
                  COLOR="green"
                elif [ "$COVERAGE_INT" -ge 60 ]; then
                  COLOR="yellow"
                else
                  COLOR="red"
                fi
                echo "{\"schemaVersion\": 1, \"label\": \"coverage\", \"message\": \"${COVERAGE}%\", \"color\": \"${COLOR}\"}" > "coverage/badges/${service}.json"
              fi
            fi
          done

      - name: Upload coverage reports
        uses: actions/upload-artifact@v6
        with:
          name: coverage-reports
          path: |
            coverage/*.out
            coverage/*.html
            coverage/*.txt
            coverage/badges/*.json
          retention-days: 30

      - name: Update README with coverage badges
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')
        run: |
          REPO="${{ github.repository }}"
          BRANCH="${GITHUB_REF#refs/heads/}"
          if [ -d "coverage/badges" ] && [ -n "$(ls -A coverage/badges/*.json 2>/dev/null)" ]; then
            mkdir -p .github/badges
            cp coverage/badges/*.json .github/badges/ 2>/dev/null || true

            if [ -f README.md ]; then
              sed -i "s|REPO_PLACEHOLDER|${REPO}|g" README.md
              sed -i "s|BRANCH_PLACEHOLDER|${BRANCH}|g" README.md
            fi
          fi

      - name: Commit coverage badges and README
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')
        run: |
          if [ -d ".github/badges" ] && [ -n "$(ls -A .github/badges/*.json 2>/dev/null)" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add .github/badges/*.json README.md
            git diff --staged --quiet || git commit -m "Update coverage badges [skip ci]"
            git push || echo "No changes to commit or push failed"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
